# 방문 A/S 완료 (Visit A/S Complete) 기획서

방문 A/S 완료 양식은 현장에서 진행된 기술 지원 및 수리 업무의 결과를 최종적으로 기록하는 **'사후 서비스 결산 보고서'**입니다. `AsCompleteForm` 전용 컴포넌트를 사용하여 고도화된 체크리스트 및 재고 결산 기능을 제공하며, 이전 '방문 A/S 확정' 단계의 데이터와 차수를 계승하여 서비스 이력을 통합 관리합니다.

---

## 1. 시각 표준 및 UI/UX (Visual & UX Engineering)

### 1.1 모달 시스템 및 UI 물리학 (Physics & Modals)
*   **컴포넌트**: `TeasyModal` 표준. **`size="lg"`** 규격 사용.
*   **사일런트 포커스 가드 (Focus Hijack Prevention)**: 모달 오픈 시 브라우저가 첫 번째 입력 필드에 강제 포커스를 두어 키보드를 팝업시키는 현상을 방지하기 위해, 투명한 더미 요소(`silentRef`)에 초기 포커스를 가두는 시스템 적용.
*   **UI 페인트 딜레이 (Paint Guard)**: 데이터 처리 트랜잭션 전 UI가 "처리 중..." 상태를 확실히 렌더링할 수 있도록 **100ms의 인위적 페인트 시간**을 확보한 후 로직 수행.
*   **마이크로 리프팅 (Tactile Feedback)**: 버튼 및 인터랙티브 요소 호버 시 `cubic-bezier` 곡선을 따라 **`translateY(-1px)`** 부상하며, 클릭 시 **`scale(0.97)`**로 축소되는 물리 효과 적용.

### 1.2 입력기 및 데이터 정규화 (Data Intelligence)
*   **DateTime 제어**: 업무 완료 보고 성격상 **미래 시간 선택 및 입력이 불가**함 (`limitType="future"`). 라벨은 **"완료 일시"**로 표시.
*   **8종 공백 및 브랜드 정규화**: 모든 입력 필드에서 유니코드 공백을 제거하고, 'crm' 발견 시 **대문자 'CRM'**으로 자동 교정.
*   **동적 레이블링**: 
    *   위치 필드: **"방문처"**
    *   연락처 필드: **"현장 연락처"**
    *   상품 필드: **"점검 상품"** (A/S 확정의 '점검' 항목 승계 및 편집 가능)
*   **조판 리듬 (Visual Rhythm)**: 일시 표시 시 날짜와 시간 사이에 **'2칸 공백(`  `)'**을 강제.

---

## 2. 업무 설계 및 데이터 관리 (Engineering & Data)

### 2.1 폼 필드 구성 (Form Consistency)
*   **항목 구성**:
    1.  **점검 상품**: `as_schedule`에서 승계된 상품 리스트. 수량 및 품목 수정 가능.
    2.  **점검 증상 (Checklist)**: `as_schedule`에서 승계된 증상 리스트. **비수정(ReadOnly)** 상태이며 완료 여부를 **체크박스**로 표시.
    3.  **수행 결과 (Checklist)**: `as_schedule`에서 승계된 업무(Task) 리스트. 완료 여부를 **체크박스**로 표시.
    4.  **사용 내역 (Inventory)**: 실제 수리에 사용된 부품/자재 리스트. 재고 차감 로직과 연동.
    5.  **점검 불가 사유**: 점검 증상이나 수행 결과 중 하나라도 **'미완료'**가 존재할 경우 활성화되는 필수 입력 필드. **시공 완료 양식과 동일한 하단 배치 가이드** 적용.
    6.  **현장 사진**: 최대 10장.
*   **데이터 상속 (Auto-fill)**: 신규 작성 시 페어링된 **'방문 A/S 확정'(`as_schedule`)** 문서로부터 모든 기초 데이터(담당자, 방문처, 연락처, 점검 상품, 증상, 업무)를 자동 상속.

### 2.2 비즈니스 로직 및 트랜잭션 (Logic & Transaction)
*   **ID 선할당 (Pre-allocation)**: 문서 ID를 트랜잭션 외부에서 미리 생성.
*   **원자적 저장 및 재고 결산 (runTransaction)**:
    1.  `activities` 컬렉션에 `as_complete` 타입 문서 생성.
    2.  **재고 결산 (Delta Logic)**: 이전 저장본(수정 시)과 현재 사용 내역의 차이만큼 `assets` 및 `asset_meta` 재고를 정밀 가감.
    3.  고객 메타(`customer_meta`)의 `totalCount` 갱신.
    4.  고객 마스터(`customers`)의 `lastConsultDate` 갱신.
*   **차수 계승 (Sequence Pairing)**: 페어링된 **`as_schedule`의 `sequenceNumber`를 그대로 계승**하여 하나의 서비스 세션으로 관리 (v124.81).
*   **수정 기한의 통제**: `createdAt` 기준 **3영업일 경과 시** 수정/삭제 버튼 비활성화.

---

## 3. 타임라인 표현 표준 (Timeline Identity)

*   **식별자**: '방문 A/S 완료' 배지(**Color: `purple`**).
*   **정보 리스트 (A/S Complete Layout)**:
    *   **일시**: `일시 :  {date}  {time}`
    *   **담당**: `담당 :  {managerName}`
    *   **주소**: `주소 :  {location}`
    *   **전화**: `전화 :  010-0000-0000`
    *   **점검 상품**: `점검 상품 :  {product_list}` (`ThinParen` 적용)
    *   **점검 증상**: 체크리스트 UI (✓: 파랑, ✕: 빨강)로 표현.
    *   **수행 결과**: 체크리스트 UI (✓: 파랑, ✕: 빨강)로 표현.
    *   **사용 내역**: `사용 내역 :  {supply_list}`
    *   **사유**: 점검 불가 사유 존재 시 업무 항목 하단에 배지와 함께 노출.
*   **참고 사항**: 그레이 메모 박스(`gray.50`)에 노출.

---

## 4. 버전 기록 (Version History)

| 버전 | 날짜 | 변경 사항 |
|:---|:---|:---|
| v1.0 | 2026-02-04 | 방문 A/S 완료 기획서 초안 작성 |
| v2.0 | 2026-02-04 | 10차 정밀 감사 및 A/S 고도화 사양(체크리스트, 재고 결산, 점검 불가 사유) 통합 |

---
> [!IMPORTANT]
> 본 기획서는 `as_complete` 모듈의 고도화 구현 기준입니다. 체크리스트를 통한 점검/수행 결과의 가시화와 실제 부품 사용량에 따른 정밀 재고 결산은 서비스 품질 관리의 핵심 사양이므로 반드시 준수되어야 합니다.
