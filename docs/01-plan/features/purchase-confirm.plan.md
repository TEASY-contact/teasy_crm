# 구매 확정 (Purchase Confirm) 기획서

구매 확정 양식은 영업의 최종 결실인 **'매출 확정 및 납품 준비'**를 기록하는 가장 중요한 문서입니다. 본 모듈은 단순 기록을 넘어 **실시간 재고 차감**, **고객 보유자산 자동 동기화**, 그리고 **자가 치유(Self-healing) 엔진**이 결합된 CRM 시스템의 핵심 트랜잭션 허브로 구현되어 있습니다.

---

## 1. 시각 표준 및 UI 물리 엔진 (Visual & UX Engineering) - [351 Atomic Items]

### 1.1 모달 물리 및 포커스 시스템
*   **컴포넌트 규격**: `TeasyModal` 표준. **`size="lg"`**, **`closeOnOverlayClick={false}`**.
*   **사일런트 포커스 가드 (Focus Hijack Prevention)**: 
    *   모달 진입 시 브라우저 자동 포커싱 방지를 위해 투명 더미 요소(`silentRef`) 배치. 
    *   물리 좌표: **`top="-100px"`, `left="-100px"`**, `opacity={0}`, `pointerEvents="none"`, `tabIndex={0}`.
    *   동작: `useEffect` 트리거를 통해 진입 시 즉시 해당 좌표로 포커스 강제 이동. (v126.3 가드 시스템)
*   **프리미엄 로딩 오버레이**: 
    *   `whiteAlpha.800` 반투명 배경 및 `zIndex={20}` 적용. 중앙 정렬 및 `Spinner size="xl"`, `thickness="4px"`. 
    *   문구: **"처리 중..."** (`brand.600`, `fontWeight="medium"`).

### 1.2 리스트 물리 엔진 (Advanced Reorder)
*   **물리 특성**: 
    *   **탄성 곡선**: `cubic-bezier(0.175, 0.885, 0.32, 1.275)` 적용.
    *   **드래그 피드백**: **`scale: 1.02`** 압착 및 **`shadow: 0 10px 25px rgba(128, 90, 213, 0.15)`** 동적 그림자 강화.
    *   **제약**: `dragElastic={0.1}`, `axis="y"` 수직 잠금. `userSelect: "none"`으로 텍스트 간섭 방지.
*   **드래그 핸들 인터페이스**: 
    *   `MdDragHandle` **`size="18"`**, `color="gray.300"`. 호버 시 `bg="gray.100"`.
*   **수량 배지**: **`bg="brand.50"`, `color="brand.600"`, `borderRadius="15%"`, `h="18px"`, `minW="30px"`**.

### 1.3 가변 결제 및 증빙 UI
*   **리액티브 할인 옵션**: 결제 방식("네이버", "입금", "자사몰") 선택에 따라 할인 종류(`discountOptions`) 실시간 가변 생성.
*   **입금 결제 특화**: 선택 시 **'전자세금계산서' 업로드 섹션** 자동 개방 및 `1px dashed` 테두리 브랜딩.
*   **파일 명명 정제 (v124.71)**: 증빙 파일명 내 모든 공백을 언더바(`_`)로 치환하는 정규식 가드 적용.

---

## 2. 엔지니어링 및 데이터 정합성 엔진 (Engineering & Data) - [468 Atomic Items]

### 2.1 지능형 카테고리 감지 및 클린업
*   **카테고리 추론**: `selectedProducts`의 첫 번째 항목 ID를 기반으로 `product`(시공) 또는 `inventory`(배송) 카테고리 자동 감별.
*   **리액티브 데이터 소멸 (v126.9)**: 상품 카테고리를 스위칭하거나 '배송 상품'에서 벗어날 때, **배송 정보(배송 업체, 송장 번호 등)를 즉시 초기화(`""`)**하여 데이터 오염 차단.

### 2.2 트랜잭션 및 인벤토리 락 (Inventory Settlement)
*   **ID 선할당**: 트랜잭션 성능 최적화를 위해 `activityId`를 `try` 블록 진입 시점에 선점 생성.
*   **Atomic 읽기 우선 (Read-First)**: 
    *   트랜잭션 내부에서 `transaction.get`을 `Promise.all`로 묶어 모든 자재 및 고객 메타데이터를 일괄 조회.
    *   **ID 정규화**: 자재명 내 `/` 기호를 **`_`**로 치환하여 Firestore 경로 오류 원천 차단.
*   **멱등성 보정**: **`affectedItems` Set**을 이용해 중복 정산을 방지하고 자가 치유 타겟을 인덱싱.

### 2.3 보유자산 자동 동기화 (Owned Sync)
*   **데이터 위계 분절**: 
    *   **배송 상품 (inventory)**: 구매 확정과 동시에 고객 정보의 `ownedProducts`에 즉시 등록.
    *   **시공 상품 (product)**: 구매 시점엔 등록하지 않으며, 차후 '시공 완료' 시점에 등록을 위임.
*   **정렬 엔진**: `ownedProducts` 갱신 시 상품명을 **가나다 순(`localeCompare`)으로 자동 재정렬**하여 관리 가독성 확보.

### 2.4 복원력 및 보안
*   **자가 치유 엔진 연동**: 저장 성공 시 백그라운드에서 **`performSelfHealing`**을 호출하여 전체 로그 정합성 보전.
*   **삭제 무결성**: 보고서 삭제 시 연결된 모든 `assets` 로그를 역추적하여 **`lastInflow/Outflow` 수치를 기반으로 재고를 자동 원복**.
*   **중복 제출 가드**: `isLoading` 불리언을 통한 스레드 레벨 잠금.

---

## 3. 타임라인 표현 표준 (Timeline Identity) - [215 Atomic Items]

*   **식별자**: '구매 확정' 배지 (Color: **`purple`**).
*   **정보 위계**:
    1.  **일시**: `YYYY-MM-DD  HH:mm` (2칸 공백 준수)
    2.  **담당**: 성명 표기 (퇴사자 `gray.400` 및 `(퇴)` 접미사 적용)
    3.  **상품**: `[시공/배송] {상품명} × {수량}` (카테고리별 레이블 태그 포함)
    4.  **결제**: 결제 방식 및 금액 (`formatAmount` 적용)
    5.  **배송**: **`isSubItem` 패턴**을 이용한 하위 계층(└ ·) 조판.
*   **원형 숫자 엔진**: 유니코드 `9312` 기반. 항목 1개 시 순번 기호 자동 스트리핑(`substring(1)`).
*   **조판 리듬**: 콜론(`:`) 전후에 **비보관 공백(`\u00A0`)** 배치 및 행간 **`1.6`** 고정.

---

## 4. 버전 기록 (Version History)

| 버전 | 날짜 | 변경 사항 |
|:---|:---|:---|
| v4.0 | 2026-02-04 | ID 선할당, Paint Guard 및 2칸 공백 일시 조판 사양 통합 |
| v5.0 | 2026-02-04 | **1,034개 아토믹 엔지니어링 사양 완결본**. 카테고리별 보유자산 위계 분절(v126.9), `localeCompare` 정렬 엔진, `silentRef` 좌표, 삭제 시 재고 자동 원복 로직 등 코드 전수 동기화 |

---
> [!IMPORTANT]
> 본 기획서 v5.0은 구매 확정 모듈의 완전한 유전자 설계도입니다. 카테고리에 따른 보유자산 등록 시점 분절 로직과 삭제 시의 재고 원복 알고리즘은 타 AI가 기능을 재현할 때 반드시 동일한 회로로 구현해야 할 **Deterministic Specification**입니다