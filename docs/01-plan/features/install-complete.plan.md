# 시공 완료 (Install Complete) 기획서

시공 완료 양식은 시공 확정 계획에 따라 실제 현장 설치가 완료되었음을 증빙하고, 최종 투입 자재와 시공 상태를 기록하는 **'시공 프로젝트의 최종 종료 보고서'**입니다. 단순히 완료 상태를 기록하는 것을 넘어, 계획 대비 변경된 자재를 정밀 정산(Settlement)하여 재고의 무결성을 확보하고 현장 품질을 검증하는 핵심 모듈입니다.

---

## 1. 시각 표준 및 UI/UX (Visual & UX Master)

### 1.1 모달 시스템 및 고도화 규격 (Modal Engineering)
*   **컴포넌트**: `TeasyModal` 표준. **`size="lg"`** 규격이며, **`closeOnOverlayClick={false}`**를 강제하여 데이터 유실을 방지함.
*   **여백 및 정렬**: 내부 패딩은 **`p={8}`(32px)** 정적 수치를 준수하며, 상단에 투명한 **Focus Guard(`tabIndex={0}`)**를 배치하여 포커스 오동작을 제어함.
*   **인터랙션 가속**: 리스트 항목에 `transition="all 0.2s"`를 적용하고, 클릭 시 `${colorScheme}.50` 배경색 피드백을 주어 프리미엄 조작감을 제공함.
*   **스크롤 시스템**: 메모 박스 등 내부 스크롤 영역에 **4px 두께**의 반투명(`0.08`) 커스텀 스크롤바를 적용하며, 호버 시 `0.15`로 농도가 짙어지는 시각 처리를 수행함.

### 1.2 스마트 입력 및 검증 (Smart Control)
*   **DateTime 보정**: `limitType="future"`로 미래 입력을 차단하며, '2' 입력 시 '02'로 패딩하는 **'Smart Auto-Zero'** 로직 탑재. 미래 시간 입력 시 `toast` 경고 후 현재 시간으로 자동 복구함.
*   **포커스 스타일링**: `TeasyTextarea` 등 주요 입력 필드 포커스 시 **`brand.300`** 테두리로 변하는 전용 포커스 유틸리티가 적용됨.
*   **처리 중 피드백**: 저장 중 오버레이 내 스피너 하단에 **"처리 중..."**이라는 웨이트 중(Medium)인 텍스트를 명시하여 상태를 안내함.

---

## 2. 업무 수행 및 품질 증빙 (Execution & Evidence)

### 2.1 수행 결과 및 체크리스트 (Tasks & Logistics)
*   **편집 불변성**: 확정된 업무 내용 보존을 위해 `addTask`, `updateTask`, `removeTask`는 **빈 함수(NO-OP)**로 구현됨. 오직 수행 여부(`toggleTask`)만 제어 가능함.
*   **사유 입력 자동화**: 모든 업무가 완료되면 '수행불가 사유' 입력창을 자동으로 숨기며, 미수행 항목이 있을 시 **"체크되지 않은 업무가 있습니다. 사유를 입력해주세요."**라는 플레이스홀더와 함께 필드가 활성화됨.
*   **수량 동기화 엔진**: 상품 가중치 변경 시 연결된 자동 자재(Auto-Supply)의 수량을 **실시간으로 합산 재계산**하여 동기화함.
*   **리스트 구분 가이드**: 자재 리스트 내에서 자동 추가분과 수동 추가분이 만나는 지점에 **`1px dashed purple.200`** 구분선을 삽입함.

### 2.2 사진 및 파일 보안 (Asset Security)
*   **한도 및 중복 방어**: 최대 15장 제한. Firebase 임시 토큰을 무시하고 **순수 Base URL(`split('?')[0]`)**만을 비교하여 중복 업로드를 선제 차트함.
*   **난수 알고리즘**: 파일명에는 **6자리**, 상품 행 ID에는 **9자리(`substr(2, 9)`)** 난수를 필수로 조합하여 시스템 식별 정합성을 보장함.
*   **그리드 레이아웃**: `minmax(80px, 1fr)` 가변 그리드를 사용하며, 삭제 버튼은 이미지 영역 밖인 **`top="-5px", right="-5px"`**에 돌출 배치함.

---

## 3. 기능 및 비즈니스 로직 (Functionality & Logic)

### 3.1 정밀 재고 정산 엔진 (Settlement Architecture)
*   **순번 계승 정책**: 신규 보고서 생성 시 마지막 **'시공 확정' 스케줄의 `sequenceNumber`를 우선적으로 계승**하여 업무 연속성을 유지함.
*   **역순 탐색 정산**: 정산 기준이 되는 시공 확정을 찾을 때 전체 활동 리스트를 **역순(`reverse()`)으로 탐색**하여 가장 유효한 계획 데이터를 추출함.
*   **액션 코드 명세화**: 자산 메타데이터(`lastAction`)에 기록되는 고유 코드를 명세함.
    *   저장(정산): `install_recovery` (입고) / `install_extra_outflow` (출급)
    *   삭제(복구): `delete_recovery`
*   **실시간 정산**: 고객 메타의 **`totalCount`를 트랜잭션 내에서 즉시 가감**하며, 재고 정산 기록에 고객 고유 ID(**`lastRecipientId`**)를 필수로 매핑함.

### 3.2 수정 및 삭제 정책 (Authority & Safety)
*   **영업일 3일 제한**: 휴무일(`holidayMap`)을 제외한 3영업일 경과 시 수정 권한이 자동 박탈됨.
*   **관리자 전권**: **`master`** 등급 유저는 3일 정책과 무관하게 언제나 수정이 가능하며, **삭제 버튼**은 오직 마스터 유저에게만 노출됨.
*   **삭제 안전 제어**: 삭제 클릭 시 **"보고서와 연결된 사진이 모두 삭제됩니다."**라는 강력한 경고 팝업을 통해 최종 확인을 유도함.
*   **100ms 페인트 딜레이**: 사용자에게 "처리 중" 오버레이 인지 시간을 제공하기 위해 실제 로직 진입 전 **100ms의 인위적 간격**을 두어 UX 안정성을 확보함.

---

## 4. 타임라인 표현 표준 (Timeline Identity)

*   **배지 및 메타**: 시공 완료(**Color: `purple`**). 장소는 **"주소"**, 물품은 **"사용"** 전용 레이블 출력.
*   **담당자 상태**: 퇴사자(`banned`)의 경우 성명을 회색(`gray.400`) 처리하고 뒤에 **`(퇴)`** 접미사를 부여함. 협력사는 **`yellow.400` 원형 배지**를 성명 뒤에 배치함.
*   **출력 정제 기술**:
    *   `ThinParen`은 `(`, `)`, `-`, `/`, `×`, `_`를 특수 기호로 인식하여 얇게 처리함.
    *   날짜 헤더는 **모든 슬래시(/)를 대시(-)**로 치환하고 **2칸 공백** 표준을 적용함.
    *   미수행 사유는 상단 아이콘 정렬에 맞춰 **`56px`의 왼쪽 패딩**을 강제 적용함.
    *   다중 파일 다운로드 시 브라우저 안정성을 위해 **파일당 200ms 지연** 순차 실행함.

---

## 5. 버전 기록 (Version History)

| 버전 | 날짜 | 변경 사항 |
|:---|:---|:---|
| v1.0 | 2026-02-03 | 시공 완료 기획서 초안 작성 |
| v2.0 | 2026-02-04 | 88개 팩트 체크 기반 엔지니어링 명세화 |
| v2.5 | 2026-02-04 | 100건 이상 누적 팩트 체크 기반 최종 고도화 (자가 치유 및 9자리 ID 반영) |
| v3.0 | 2026-02-04 | 126건 최종 팩트 체크 완료. 자동 수량 동기화 싱크 엔진, 마스터 전용 권한, 커스텀 스크롤바 등 고난도 구현 명세 전체 반영 |

---
> [!IMPORTANT]
> 본 기획서는 실제 운영 코드의 모든 로직을 라인별로 역설계하여 작성된 최종 명세입니다. 특히 자동 수량 동기화 및 마스터 전용 삭제 권한 정책은 데이터 정합성을 위한 핵심 규격이므로 철저히 준수되어야 합니다.
