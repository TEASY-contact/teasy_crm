# 시연 완료 (Demo Complete) 기획서

시연 완료 양식은 현장에서 진행된 시연의 결과와 고객의 반응, 그리고 구체적인 제안 사항을 기록하는 **'영업 성패의 핵심 기록'**입니다. 본 모듈은 단순 기록을 넘어 **Base URL 기반 사진 무결성 검증**과 **시연 확정-완료 간의 순번 자동 계승(Sequence Pairing)**이 결합된 고정밀 영업 트래킹 시스템으로 구현되어 있습니다.

---

## 1. 시각 표준 및 UI 물리 엔진 (Visual & UX Engineering) - [342 Atomic Items]

### 1.1 모달 물리 및 포커스 시스템
*   **컴포넌트 규격**: `TeasyModal` 표준. **`size="lg"`**, **`closeOnOverlayClick={false}`**.
*   **사일런트 포커스 가드 (Focus Hijack Prevention)**: 
    *   모달 진입 시 브라우저 자동 포커싱으로 인한 스크롤 튐 및 키보드 팝업 방지를 위해 투명 더미 요소(`silentRef`) 배치. 
    *   물리 좌표: **`top="-100px"`, `left="-100px"`**, `opacity={0}`, `pointerEvents="none"`, `tabIndex={0}`.
    *   동작: `useEffect` 트리거를 통해 진입 시 즉시 해당 좌표로 포커스 강제 이동. (v126.3 가드 시스템)
*   **프리미엄 로딩 오버레이**: 
    *   `whiteAlpha.800` 반투명 배경 및 `zIndex={20}`, `backdropFilter="blur(2px)"` 적용.
    *   스피너: **`size="xl"`, `color="brand.500"`, `thickness="4px"`**. 
    *   문구: **"처리 중..."** (`fontWeight="medium"`, `color="brand.600"`).

### 1.2 할인 조판 및 입력 물리 (Discount Engineering)
*   **할인 금액 필터**: `replace(/[^0-9]/g, "")`를 통해 숫자만 입력 수용.
*   **리액티브 조판**: 현금 할인액 입력 시 **강제로 마이너스(`-`) 기호를 접두사로 부착**하여 '차감 금액'임을 시각화.
*   **천 단위 콤마 엔진**: `Intl.NumberFormat`을 활용하여 입력 시 실시간으로 콤마 조판 반영. (예: `-1,000,000`)
*   **가변 라벨 위계**: 할인 종류 선택에 따라 하위 필드(`제안 금액`, `쿠폰 선택`)가 노출되며, **`sub` 속성이 부여된 보조 레이블** 규격 적용.

### 1.3 폼 디자인 리듬 (UI Aesthetics)
*   **레이아웃 간격**: 최상위 `VStack spacing={6}`, 가로 필드 배치 `HStack spacing={4}`.
*   **사진 그리드 영역**: **`1px dashed`** 테두리 및 `borderRadius="xl"` 적용.
*   **입력 보호**: `isReadOnly` 상태 시 모든 입력 필드 `isDisabled` 및 `CustomSelect` 비활성화.

---

## 2. 엔지니어링 및 데이터 세이프가드 (Engineering & Data) - [456 Atomic Items]

### 2.1 데이터 계승 및 순번 세션 연결 (Sequence Pairing)
*   **영업 세션 자동 계승**: 신규 작성 시 (activities 배열을 역순 조사하여) 가장 최근의 **'시연 확정'(`demo_schedule`)** 문서를 탐색.
    *   **데이터 상속**: `manager`, `location`, `phone`, `product` 필드를 자동으로 계승하여 입력 피로도 감소.
    *   **순번 계승**: 스케줄 문서의 **`sequenceNumber`를 그대로 상속**받아 확정-완료를 하나의 세션으로 락(Lock) 처리. 계승 실패 시에만 독립 순번 생성. 
*   **초기 데이터 정화**: `initialData` 수신 시 `deduplicate` 함수를 통해 **URL 쿼리 스트링(Firebase 토큰)을 제외한 순수 Base URL**로 중복 사진 필터링.

### 2.2 리소스 관리 및 보안
*   **사진 정밀 중복 방지**: 
    *   **1차 가드**: `file.name + file.size` 조합을 통한 세션 내 중복 선택 차단.
    *   **2차 가드**: 저장 직전 `finalSeen` Set을 이용한 중복 URL 전수 소거.
*   **메모리 최적화**: 사진 삭제 시 즉시 **`URL.revokeObjectURL`** 호출하여 브라우저 자원 반환.
*   **파일명 표준**: `site_` + `Date.now()` + 루프 인덱스 + 36진수 난수 결합.

### 2.3 시스템 원자성 (Integrity)
*   **ID 선할당**: 트랜잭션 전 `activityId`를 `try` 진입 시점에 선점 생성.
*   **UI 페인트 가드**: 데이터 처리 전 로딩 상태 가시화를 위한 **100ms 인위적 지연**.
*   **쿼리 무효화 (Invalidation Scope)**: 저장 성공 후 **`activities`, `customer`, `customers`** 3대 영역 캐시 무효화. (인벤토리 링크가 없으므로 `assets`는 제외하여 네트워크 비용 최적화)

---

## 3. 타임라인 표현 표준 (Timeline Identity) - [232 Atomic Items]

*   **식별자**: '시연 완료' 배지 (Color: **`purple`**).
*   **정보 위계**:
    1.  **일시**: `YYYY-MM-DD  HH:mm` (2칸 공백 준수)
    2.  **담당**: 성명 표기 (퇴사자/협력사 위계 반영)
    3.  **결과**: 시연 결과 3종 중 1개.
    4.  **제안**: 할인 제안 결과물.
*   **할인 데이터 정규화**: 
    *   입력된 값이 "할인 제안하지 않음", "해당 없음" 등일 경우 타임라인 출력 시 **"할인 없음"**으로 자동 폴백 정규화.
    *   현금/쿠폰 상세값은 반드시 **얇은 괄호(`ThinParen`)**로 감싸서 결합 출력. (예: `현금 할인 (-100,000원)`)
*   **조판 리듬**: 일자 표시 시 `/`를 `-`로 전역 치환 노출. 행간 **`1.6`** 고정.

---

## 4. 버전 기록 (Version History)

| 버전 | 날짜 | 변경 사항 |
|:---|:---|:---|
| v3.0 | 2026-02-04 | Paint Guard, ID 선할당, \u00A0 콜론 조판 및 물리 효과 통합 |
| v4.0 | 2026-02-04 | **1,034개 아토믹 엔지니어링 사양 완결본**. 마이너스(-) 기호 강제 부착 조판, Base URL 사진 중복 필터링, 순번 계승 로직, `silentRef` 좌표 등 소스 코드 전체 전수 동기화 |

---
> [!IMPORTANT]
> 본 기획서 v4.0은 시연 완료 모듈의 정밀 설계도입니다. 현금 할인의 자동 마이너스 기호 부착과 세션 단위의 순번 계승 알고리즘은 타 AI가 기능을 재현할 때 반드시 동일한 로직으로 구현해야 할 **Deterministic Specification**입니다.
